<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Valgt Drink</title>
  <link rel="stylesheet" href="../CSS/MainStyle.css">
  <link rel="stylesheet" href="../CSS/ButtonStyle.css">
  <link rel="stylesheet" href="../CSS/ValgDrinkStyle.css">
</head>
<body>
<div class="bg">
    <div class="overlay">
      <div class="container">
        <h2 id="drinkName"></h2>
        <img class="DrinkIMG" id="drinkImage" src="" alt="">
        <div class="ListContainer">
            <ul id="ingredientsList"></ul>
        </div>
      </div>
    <div class="buttonDiv">
        <button class="glow-button-orange buttons" onclick="window.location.href='VaelgDrinks.html'">Tilbage</button>
        <button class="glow-button-green buttons" onclick="startProgress()">Start</button>
    </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const drinkName = sessionStorage.getItem("selectedDrinkName") || "Ukendt Drink";
    const drinkImage = sessionStorage.getItem("selectedDrinkImage") || "../Images/default.png";
    const ingredients = JSON.parse(sessionStorage.getItem("selectedDrinkIngredients")) || [];

    document.getElementById("drinkName").innerText = drinkName;
    document.getElementById("drinkImage").src = drinkImage;
    document.getElementById("drinkImage").alt = drinkName;

    const ingredientsList = document.getElementById("ingredientsList");
    ingredients.forEach(ingredient => {
      const li = document.createElement("li");
      li.innerText = (ingredient && ingredient.title) ? ingredient.title : "Ukendt ingrediens";
      ingredientsList.appendChild(li);
    });
});

async function startProgress() {
    const drinkIdStr = localStorage.getItem("selectedDrinkId");
    const bottlesString = sessionStorage.getItem("selectedDrinkIngredients");
    const scriptName = sessionStorage.getItem("selectedDrinkScript");

    const selectedDrinkName = sessionStorage.getItem("selectedDrinkName") || "Ukendt Drink";
    const selectedDrinkImage = sessionStorage.getItem("selectedDrinkImage") || "../Images/default.png";

    if (!drinkIdStr) {
        alert("Drink mangler. PrÃ¸v igen.");
        return;
    }

    let drink_id;
    try { drink_id = JSON.parse(drinkIdStr); } catch { drink_id = Number(drinkIdStr) || drinkIdStr; }

    let bottle_ids = [];
    let ingredientTitles = [];
    try {
        const bottles = JSON.parse(bottlesString || "[]");
        bottle_ids = bottles.map(bottle => bottle.bottle_id).filter(Boolean);
        ingredientTitles = bottles.map(bottle => bottle.title).filter(Boolean);
    } catch (error) {
        console.warn("Fejl ved parsing af flasker:", error);
    }

    try {
        if (scriptName) {
            // Store data for finished-drink progress page
            sessionStorage.setItem("progressDrinkName", selectedDrinkName);
            sessionStorage.setItem("progressDrinkImage", selectedDrinkImage);
            sessionStorage.setItem("progressDrinkIngredients", JSON.stringify(ingredientTitles));

            // Start single script program before redirect
            await fetch('http://localhost:5001/api/run_program', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ script: scriptName })
            });

            // Update drink count
            await fetch('http://localhost:5001/api/add_count_drink', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ drink_id: drink_id })
            });

            // Now navigate to progress page
            window.location.href = "progressFL.html";
        } else {
            // Store data for mix-by-bottles progress page
            sessionStorage.setItem("drinkName", selectedDrinkName);
            sessionStorage.setItem("selectedIngredients", JSON.stringify(ingredientTitles));

            // Start mix by bottle ids before redirect
            await fetch('http://localhost:5001/api/mixdrink', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bottles: bottle_ids })
            });

            // Update bottle counts
            await fetch('http://localhost:5001/api/add_bottle_counts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bottles: bottle_ids })
            });

            // Update drink count
            await fetch('http://localhost:5001/api/add_count_drink', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ drink_id: drink_id })
            });

            // Navigate to progress page
            window.location.href = "progressMix.html";
        }
    } catch (error) {
        console.error("Fejl under start:", error);
        alert("Noget gik galt. Se konsollen for detaljer.");
    }
}
</script>
</body>
</html>