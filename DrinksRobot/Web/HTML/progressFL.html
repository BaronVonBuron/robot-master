<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Valgt Drink</title>
  <link rel="stylesheet" href="../CSS/MainStyle.css">
  <link rel="stylesheet" href="../CSS/ButtonStyle.css">
  <link rel="stylesheet" href="../CSS/progress.css">
</head>
<body>
<div class="bg">
  <div class="overlay">
    <div class="container">
      <h2 id="drinkTitle"></h2>
      <img class="DrinkIMG" id="drinkImage" src="" width="100">
      <div class="ListContainer">
        <ul id="ingredientList"></ul>
      </div>
    </div>
    <div id="progressLabel">Hælder...</div>
    <div class="progressWrapper">
      <div id="progressBar"></div>
    </div>
    <div class="buttonDiv">
      <button class="glow-button-orange buttons" onclick="pauseRobot()">Pause</button>
      <button class="glow-button-green buttons" onclick="resumeRobot()">Fortsæt</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const drinkName = sessionStorage.getItem("progressDrinkName") || sessionStorage.getItem("drinkName") || "Ukendt Drink";
  const drinkImage = sessionStorage.getItem("progressDrinkImage") || "../Images/mystery.png";
  const ingredients = JSON.parse(sessionStorage.getItem("progressDrinkIngredients") || sessionStorage.getItem("ingredients") || "[]");

  document.getElementById("drinkTitle").innerText = drinkName;
  document.getElementById("drinkImage").src = drinkImage;
  document.getElementById("drinkImage").alt = drinkName;

  const ul = document.getElementById("ingredientList");
  ingredients.forEach(ingredient => {
    if (!ingredient || ingredient === "Ingen") return;
    const li = document.createElement("li");
    li.innerText = ingredient;
    ul.appendChild(li);
  });

  pollProgress();
  setInterval(updateProgramLabel, 3000);
});

function pollProgress() {
  fetch('http://localhost:5001/robot_progress')
    .then(res => res.json())
    .then(data => {
      const done = data.done || 0;
      const total = data.total || 1;
      const percent = Math.min((done / total) * 100, 100);
      document.getElementById("progressBar").style.width = percent + "%";

      if (percent >= 100) {
        setTimeout(() => window.location.href = "index.html", 1500);
      } else {
        setTimeout(pollProgress, 1500);
      }
    })
    .catch(err => {
      console.error("Fejl ved progress poll:", err);
      setTimeout(pollProgress, 2000);
    });
}

function updateProgramLabel() {
  fetch('http://localhost:5001/current_program')
    .then(res => res.json())
    .then(data => {
      if (data.program && data.program.trim() !== "") {
        const cleaned = data.program.replace(".urp", "");
        let labelText = "Hælder...";
        if (cleaned.startsWith("hentflaske")) {
          labelText = "Henter flasker";
        } else if (cleaned.startsWith("skenkflaske")) {
          labelText = "Skænker";
        } else if (cleaned.startsWith("tilbageflaske")) {
          labelText = "Stiller flaske tilbage";
        } else if (cleaned.startsWith("tilbagekop")) {
          labelText = "Stiller kop tilbage";
        } else if (cleaned.startsWith("skenkkop")) {
          labelText = "Skænker";
        } else if (cleaned.startsWith("hentkop")) {
          labelText = "Henter kop";
        } else {
          labelText = "Hælder " + cleaned;
        }
        document.getElementById("progressLabel").innerText = labelText;
      } else {
        document.getElementById("progressLabel").innerText = "Hælder...";
      }
    })
    .catch(err => {
      console.error("Fejl ved hentning af programnavn:", err);
    });
}

function pauseRobot() {
  fetch('http://localhost:5001/api/pause', { method: 'POST' })
    .catch(err => console.error('Pause error:', err));
}

function resumeRobot() {
  fetch('http://localhost:5001/api/resume', { method: 'POST' })
    .catch(err => console.error('Resume error:', err));
}
</script>
</body>
</html>